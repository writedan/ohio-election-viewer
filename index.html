<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ohio Election Visualizer</title>
  <!-- Include Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Include Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Include Leaflet Shapefile JavaScript -->
  <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
  <script src="http://calvinmetcalf.github.io/leaflet.shapefile/leaflet.shpfile.js"></script>
  <style>
    body {
    margin: 0;
    display: flex;
  }

  #map {
    width: 75%;
    height: 100vh;
  }

  #info-box {
    width: 25%;
    height: 100vh;
    box-sizing: border-box;
    padding: 20px;
    background-color: #f0f0f0;
    border-left: 1px solid;
  }

  .candidate-box {
    border: 1px solid #ccc;
    margin-bottom: 10px;
    padding: 10px;
    background-color: #f9f9f9;
    /*cursor: pointer; /* Add pointer cursor for clickable effect 
    transition: background-color 0.3s; /* Smooth transition for background color change on mouseover */
  }

  .election-box {
    cursor: pointer; /* Add pointer cursor for clickable effect  */
    transition: background-color 0.3s; /* Smooth transition for background color change on mouseover */
  }

  .election-box:hover {
    background-color: #e0e0e0;
  }

  /*.candidate-box:hover {
    background-color: #e0e0e0; /* Change background color on mouseover */
  }*/

  .candidate-name {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .candidate-percentage {
    float: right;
    margin-top: -20px; /* Adjust as needed for alignment */
  }

  .candidate-raw-votes {
    font-size: 0.8em;
    margin-top: 5px;
    color: #888;
  }

  #candidates {
    overflow-y: auto; /* Make the info-box scrollable */
    height: 90%;
  }

  .back-button {
    cursor: pointer;
    transition: background-color 0.3s;
    transition: color 0.3s;
    background-color: #2554a9;
    color: white;
  }

  .back-button:hover {
    background-color: #f9f9f9;
    color: black;
    border: 2px solid #007bff;
  }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <script>

        async function loadDatabase(){
          window.SQL = await initSqlJs({
          // Required to load the wasm binary asynchronously. Of course, you can host it wherever you want
          // You can omit locateFile completely when running in node
          locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.wasm`
        });
          await fetch('http://localhost:3000/elections.db')
            .then(response => response.arrayBuffer())
            .then(buffer => {
                let db = new SQL.Database(new Uint8Array(buffer));
                window.db = db; // this exports `db` as a global variable
            })
            .catch(error => {
                console.error('Error fetching or loading the database:', error);
            });}
    </script>
</head>


<body>

<!-- Create a div to hold the map -->
<div id="map"></div>
<div id="info-box">
  <h2 id="county-name">Ohio Election Visualizer</h2>
  <div id="candidates">
  </div>
</div>

<script>
  function toTitleCase(str) {
    return str.replace(/\w\S*/g, function (txt) {
      return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
    });
  }

    // Initialize the map
  var map = L.map('map').setView([39.9612, -82.9988], 7); // Set initial coordinates and zoom level

  // Add a tile layer (you can use other tile providers)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  // Load county Shapefile data using Leaflet Shapefile
  //var countyLayer, subdivisionLayer;

  async function loadCountyShapefile(url) {
    let countyLayer;
    await shp(url).then(function (geojson) {
      if (geojson) {
        countyLayer = L.geoJSON(geojson);
        console.log("County shapefile loaded.")
      } else {
        console.error('Error loading county Shapefile.');
      }
    }).catch(function (error) {
      console.log(error)
      console.error('Error loading county Shapefile:', error);
    });
    manifest.countyLayer = countyLayer;
  }

  async function loadSubdivisionShapefile(url) {
    let subdivisionLayer;
    await shp(url).then(function (geojson) {
      if (geojson) {
        subdivisionLayer = L.geoJSON(geojson);
        console.log("Loaded subdivision shapefile")
      } else {
        console.error('Error loading subdivision Shapefile.');
      }
    }).catch(function (error) {
      console.error('Error loading subdivision Shapefile:', error);
    });

    manifest.subdivisionLayer = subdivisionLayer;
  }

  // Listen for map moveend event
  map.on('zoomend', function () {
    // Get the current bounds of the map
    var bounds = map.getBounds();

    // Check if, for example, 50% of the state has come back into view
    // You can adjust this threshold as needed
    if (checkPercentageInView(bounds) > 0.25) {
      if (map.hasLayer(manifest.subdivisionLayer)) {
        map.addLayer(manifest.countyLayer);
        map.removeLayer(manifest.subdivisionLayer);
      }
    }
  });

  function checkPercentageInView(bounds) {
    // Define the bounding box of the state (adjust these coordinates based on your state)
    var stateBounds = L.latLngBounds(
      L.latLng(37.7719, -85.6052), // Southwest corner
      L.latLng(41.9773, -80.5188)  // Northeast corner
    );

    // Get the intersection of the state bounds and the current map bounds
    var intersection = getIntersection(bounds, stateBounds);

    // Calculate the percentage of the state bounds that is in view
    var percentageInView = (intersection.getNorthEast().lat - intersection.getSouthWest().lat) / (stateBounds.getNorthEast().lat - stateBounds.getSouthWest().lat);

    // You can adjust the threshold percentage as needed (e.g., 0.5 for 50%)
    return percentageInView;
  }

  // Function to calculate the intersection of two bounding boxes
  function getIntersection(bounds1, bounds2) {
    var swLat = Math.max(bounds1.getSouthWest().lat, bounds2.getSouthWest().lat);
    var swLng = Math.max(bounds1.getSouthWest().lng, bounds2.getSouthWest().lng);
    var neLat = Math.min(bounds1.getNorthEast().lat, bounds2.getNorthEast().lat);
    var neLng = Math.min(bounds1.getNorthEast().lng, bounds2.getNorthEast().lng);

    return L.latLngBounds(L.latLng(swLat, swLng), L.latLng(neLat, neLng));
  }

</script>


<script>
  function stmt(sqlStatement, parameters = []) {
    const statement = db.prepare(sqlStatement);

    try {
        statement.bind(parameters);

        const resultSet = [];
        while (statement.step()) {
            resultSet.push(statement.getAsObject());
        }

        return resultSet;
    } finally {
        statement.free();
    }
  }

  var manifest = {}

  function loadElectionManifest() {
    var elections = stmt("select * from election_info")
    var candidateBox = document.getElementById("candidates");
    candidateBox.innerHTML = '';
    for (let election of elections) {
      var candidate = document.createElement("div");
      candidate.classList.add("candidate-box");
      candidate.classList.add("election-box")

      var candidateName = document.createElement("div")
      candidateName.className = "candidate-name"
      candidateName.innerHTML = election.name
      candidate.appendChild(candidateName)

      var candidateVotes = document.createElement("div")
      candidateVotes.className = "candidate-raw-votes"
      candidateVotes.innerHTML = election.date + ', ' + election.year;
      candidate.appendChild(candidateVotes)

      candidateBox.appendChild(candidate);
      candidate.onclick = function(){
        manifest.election = election
        loadCategoryManifest(election.id)
      };
    }
  }

  function loadCategoryManifest(electionId) {
    // at this point we have enough information to load the county and subdivision layers
    manifest.layerLoading = async function(){
      var url = 'http://localhost:3000/elections/' + manifest.election.year + '/' + manifest.election.type + '-maps/'
      loadCountyShapefile(url + 'county/county')
      loadSubdivisionShapefile(url + 'subdivision/subdivision')
    }();

    var candidateBox = document.getElementById("candidates");
    candidateBox.innerHTML = '';

    var goBack = document.createElement("div");
    goBack.classList.add("candidate-box");
    goBack.classList.add("back-button");

    var goBackN = document.createElement("div")
    goBackN.className = "candidate-name"
    goBackN.innerHTML = 'Back to <b>Election Index</b>';
    goBack.appendChild(goBackN)
    goBack.onclick = function(){
      loadElectionManifest()
    }
    candidateBox.appendChild(goBack)

    var categories = stmt("select * from office_category where electionId=?", [electionId])
    for (let category of categories) {
      var candidate = document.createElement("div")
      candidate.classList.add("candidate-box");
      candidate.classList.add("election-box")

      var candidateName = document.createElement("div")
      candidateName.className = "candidate-name"
      candidateName.innerHTML = category.name
      candidate.appendChild(candidateName)

      candidateBox.appendChild(candidate);
      candidate.onclick = function(){
        manifest.category = category;
        loadOfficeManifest(category.id)
      };
    }
  }

  function loadOfficeManifest(categoryId) {
    var candidateBox = document.getElementById("candidates");
    candidateBox.innerHTML = '';

    map.eachLayer(function (layer) {
      if (layer == manifest.countyLayer || layer == manifest.subdivisionLayer) {
        map.removeLayer(layer);
      }
    }); // we need the map cleared, else it will accumulate

    var goBack = document.createElement("div");
    goBack.classList.add("candidate-box");
    goBack.classList.add("back-button");
    //goBack.style.backgroundColor='grey';

    var goBackN = document.createElement("div")
    goBackN.className = "candidate-name"
    goBackN.innerHTML = 'Back to <b>' + manifest.election.name + '</b>';
    goBack.appendChild(goBackN)
    goBack.onclick = function(){
      loadCategoryManifest(manifest.election.id)
    }
    candidateBox.appendChild(goBack)

    var offices = stmt("select * from office_election where categoryId=?", [categoryId])
    for (let office of offices) {
      var candidate = document.createElement("div")
      candidate.classList.add("candidate-box");
      candidate.classList.add("election-box")

      var candidateName = document.createElement("div")
      candidateName.className = "candidate-name"
      candidateName.innerHTML = office.name
      candidate.appendChild(candidateName)

      candidateBox.appendChild(candidate);
      candidate.onclick = function(){
        manifest.office = office;
        displayElection(manifest);
      };
    }
  }

  async function displayElection(manifest) {
    var candidateBox = document.getElementById('candidates');
    candidateBox.innerHTML = '';

    var goBack = document.createElement("div");
    goBack.classList.add("candidate-box");
    goBack.classList.add("back-button");
   // goBack.style.backgroundColor='grey';

    var goBackN = document.createElement("div")
    goBackN.className = "candidate-name"
    goBackN.innerHTML = 'Back to <b>' + manifest.category.name + '</b>';
    goBack.appendChild(goBackN)
    goBack.onclick = function(){
      loadOfficeManifest(manifest.category.id)
    }
    candidateBox.appendChild(goBack)

    await manifest.layerLoading; // if the shapefiles aren't yet loaded, we need to wait for them
    manifest.countyLayer.addTo(map);

    var candidates = stmt("select * from candidate where officeId=?", [manifest.office.id])
    for (let candidate of candidates) {
      var cb = document.createElement("div");
      cb.classList.add("candidate-box");

      var candidateName = document.createElement("div")
      candidateName.className = "candidate-name"
      candidateName.innerHTML = candidate.name
      cb.appendChild(candidateName)

      candidateBox.appendChild(cb);
    }
  }

  manifest.databaseLoad = loadDatabase();

  async function work() {
    await manifest.databaseLoad;
    loadElectionManifest();
  }

  work();

  // manifest.viewCreator = async function(){
  //   await manifest.databaseLoad;
  //     db.exec("create table precinct_results_view as select * from precinct_results;")
  //     // db.exec("create table municipal_results_view as select * from municipal_results;")
  //     // db.exec("create table county_results_view as select * from county_results;")
  //   }(); // this function will create tables out of all the views and thus dramatically speed up queries, for initial cost
</script>

</body>
</html>