<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ohio Election Visualizer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
  <script src="http://calvinmetcalf.github.io/leaflet.shapefile/leaflet.shpfile.js"></script>

  <script>
    function generateUUID() { // Public Domain/MIT
      var d = new Date().getTime();//Timestamp
      var d2 = ((typeof performance !== 'undefined') && performance.now && (performance.now()*1000)) || 0;//Time in microseconds since page-load or 0 if unsupported
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16;//random number between 0 and 16
          if(d > 0){//Use timestamp until depleted
              r = (d + r)%16 | 0;
              d = Math.floor(d/16);
          } else {//Use microseconds since page-load if supported
              r = (d2 + r)%16 | 0;
              d2 = Math.floor(d2/16);
          }
          return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
      });
    }

    // thanks to https://stackoverflow.com/a/8809472
  </script>

  <script src="sql.js"></script>
  <style>
    body {
    margin: 0;
    display: flex;
  }

  #map {
    width: 75%;
    height: 100vh;
  }

  #info-box {
    width: 25%;
    height: 100vh;
    box-sizing: border-box;
    padding: 20px;
    background-color: #f0f0f0;
    border-left: 1px solid;
  }

  .candidate-box {
    border: 2px solid #ccc;
    margin-bottom: 10px;
    padding: 10px;
    background-color: #f9f9f9;
    /*cursor: pointer; /* Add pointer cursor for clickable effect 
    transition: background-color 0.3s; /* Smooth transition for background color change on mouseover */
  }

  .election-box {
    cursor: pointer; /* Add pointer cursor for clickable effect  */
    transition: background-color 0.3s; /* Smooth transition for background color change on mouseover */
  }

  .election-box:hover {
    background-color: #e0e0e0;
  }

  /*.candidate-box:hover {
    background-color: #e0e0e0; /* Change background color on mouseover */
  }*/

  .candidate-name {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .candidate-percentage {
    float: right;
    margin-top: -20px; /* Adjust as needed for alignment */
  }

  .candidate-raw-votes {
    font-size: 0.8em;
    margin-top: 5px;
    color: #888;
  }

  #candidates {
    overflow-y: auto; /* Make the info-box scrollable */
    height: 90%;
  }

  .back-button {
    cursor: pointer;
    transition: background-color 0.3s;
    transition: color 0.3s;
    background-color: #2554a9;
    color: white;
    border: 2px solid #2554a9;
  }

  .back-button:hover {
    background-color: #f9f9f9;
    color: black;
    border: 2px solid #007bff;
  }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <script>
    </script>
</head>


<body>

<!-- Create a div to hold the map -->
<div id="map"></div>
<div id="info-box">
  <h2 id="county-name">Ohio Election Visualizer</h2>
  <div id="candidates">
  </div>
</div>

<script>
  var map = L.map('map').setView([39.9612, -82.9988], 7); 

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  async function loadCountyShapefile(url) {
    let countyLayer;
    await shp(url).then(function (geojson) {
      if (geojson) {
        countyLayer = L.geoJSON(geojson);
        console.log("County shapefile loaded.")
      } else {
        console.error('Error loading county Shapefile.');
      }
    }).catch(function (error) {
      console.log(error)
      console.error('Error loading county Shapefile:', error);
    });
    manifest.countyLayer = countyLayer;
  }

  async function loadSubdivisionShapefile(url) {
    let subdivisionLayer;
    await shp(url).then(function (geojson) {
      if (geojson) {
        subdivisionLayer = L.geoJSON(geojson);
        console.log("Loaded subdivision shapefile")
      } else {
        console.error('Error loading subdivision Shapefile.');
      }
    }).catch(function (error) {
      console.error('Error loading subdivision Shapefile:', error);
    });

    manifest.subdivisionLayer = subdivisionLayer;
  }

  map.on('zoomend', function () {
    var bounds = map.getBounds();

    if (checkPercentageInView(bounds) > 0.25) {
      if (map.hasLayer(manifest.subdivisionLayer)) {
        map.addLayer(manifest.countyLayer);
        map.removeLayer(manifest.subdivisionLayer);
      }
    }
  });

  function checkPercentageInView(bounds) {
    var stateBounds = L.latLngBounds(
      L.latLng(37.7719, -85.6052), // Southwest corner
      L.latLng(41.9773, -80.5188)  // Northeast corner
    );

    var intersection = getIntersection(bounds, stateBounds);

    var percentageInView = (intersection.getNorthEast().lat - intersection.getSouthWest().lat) / (stateBounds.getNorthEast().lat - stateBounds.getSouthWest().lat);

    return percentageInView;
  }

  function getIntersection(bounds1, bounds2) {
    var swLat = Math.max(bounds1.getSouthWest().lat, bounds2.getSouthWest().lat);
    var swLng = Math.max(bounds1.getSouthWest().lng, bounds2.getSouthWest().lng);
    var neLat = Math.min(bounds1.getNorthEast().lat, bounds2.getNorthEast().lat);
    var neLng = Math.min(bounds1.getNorthEast().lng, bounds2.getNorthEast().lng);

    return L.latLngBounds(L.latLng(swLat, swLng), L.latLng(neLat, neLng));
  }

</script>


<script>
  var manifest = {}

  function loadElectionManifest() {
    document.getElementById('county-name').innerHTML = 'Ohio Election Visualizer';
    var elections = stmt("select * from election_info")
    var candidateBox = document.getElementById("candidates");
    candidateBox.innerHTML = '';
    for (let election of elections) {
      var candidate = document.createElement("div");
      candidate.classList.add("candidate-box");
      candidate.classList.add("election-box")

      var candidateName = document.createElement("div")
      candidateName.className = "candidate-name"
      candidateName.innerHTML = election.name
      candidate.appendChild(candidateName)

      var candidateVotes = document.createElement("div")
      candidateVotes.className = "candidate-raw-votes"
      candidateVotes.innerHTML = election.date + ', ' + election.year;
      candidate.appendChild(candidateVotes)

      candidateBox.appendChild(candidate);
      candidate.onclick = function(){
        manifest.election = election
        loadCategoryManifest(election.id)
      };
    }
  }

  function loadCategoryManifest(electionId) {
    // at this point we have enough information to load the county and subdivision layers
    manifest.layerLoading = async function(){
      var url = 'http://localhost:3000/elections/' + manifest.election.year + '/' + manifest.election.type + '-maps/'
      loadCountyShapefile(url + 'county/county')
      loadSubdivisionShapefile(url + 'subdivision/subdivision')
    }();

    var candidateBox = document.getElementById("candidates");
    candidateBox.innerHTML = '';

    document.getElementById('county-name').innerHTML = manifest.election.name;

    var goBack = document.createElement("div");
    goBack.classList.add("candidate-box");
    goBack.classList.add("back-button");

    var goBackN = document.createElement("div")
    goBackN.className = "candidate-name"
    goBackN.innerHTML = 'Back to <b>Election Index</b>';
    goBack.appendChild(goBackN)
    goBack.onclick = function(){
      loadElectionManifest()
    }
    candidateBox.appendChild(goBack)

    var categories = stmt("select * from office_category where electionId=?", [electionId])
    for (let category of categories) {
      var candidate = document.createElement("div")
      candidate.classList.add("candidate-box");
      candidate.classList.add("election-box")

      var candidateName = document.createElement("div")
      candidateName.className = "candidate-name"
      candidateName.innerHTML = category.name
      candidate.appendChild(candidateName)

      candidateBox.appendChild(candidate);
      candidate.onclick = function(){
        manifest.category = category;
        loadOfficeManifest(category.id)
      };
    }
  }

  function loadOfficeManifest(categoryId) {
    var candidateBox = document.getElementById("candidates");
    candidateBox.innerHTML = '';

    document.getElementById('county-name').innerHTML = manifest.category.name;

    map.eachLayer(function (layer) {
      if (layer == manifest.countyLayer || layer == manifest.subdivisionLayer) {
        map.removeLayer(layer);
      }
    }); // we need the map cleared, else it will accumulate

    var goBack = document.createElement("div");
    goBack.classList.add("candidate-box");
    goBack.classList.add("back-button");
    //goBack.style.backgroundColor='grey';

    var goBackN = document.createElement("div")
    goBackN.className = "candidate-name"
    goBackN.innerHTML = 'Back to <b>' + manifest.election.name + '</b>';
    goBack.appendChild(goBackN)
    goBack.onclick = function(){
      loadCategoryManifest(manifest.election.id)
    }
    candidateBox.appendChild(goBack)

    var offices = stmt("select * from office_election where categoryId=?", [categoryId])
    for (let office of offices) {
      var candidate = document.createElement("div")
      candidate.classList.add("candidate-box");
      candidate.classList.add("election-box")

      var candidateName = document.createElement("div")
      candidateName.className = "candidate-name"
      candidateName.innerHTML = office.name
      candidate.appendChild(candidateName)

      candidateBox.appendChild(candidate);
      candidate.onclick = function(){
        manifest.office = office;
        displayElectionLoadingScreen(manifest);
      };
    }
  }

  async function displayElectionLoadingScreen(manifest) {
    document.getElementById('county-name').innerHTML = manifest.office.name;
    var candidateBox = document.getElementById('candidates');
    candidateBox.innerHTML = 'The database is still loading result data. This should only take a few seconds more.';
    manifest.materializeViews.then(() => {
      displayElection(manifest)
    })
  }

  function candidateColor(name, availableColors) {
    if ((name.includes('(R)') || name == 'No') && availableColors.red) {
      return 'red'
    }

    if (name.includes('(D)') && availableColors.blue) {
      return 'blue'
    }

    if (name == 'Yes' && availableColors.green) {
      return 'green'
    }

    return Object.keys(availableColors).pop()
  }

  async function displayElection(manifest) {
    //await manifest.materializeViews; // we cannot display an election without the database being ready



    var candidateBox = document.getElementById('candidates');
    candidateBox.innerHTML = '';

    var goBack = document.createElement("div");
    goBack.classList.add("candidate-box");
    goBack.classList.add("back-button");
   // goBack.style.backgroundColor='grey';

    var goBackN = document.createElement("div")
    goBackN.className = "candidate-name"
    goBackN.innerHTML = 'Back to <b>' + manifest.category.name + '</b>';
    goBack.appendChild(goBackN)
    goBack.onclick = function(){
      loadOfficeManifest(manifest.category.id)
    }
    candidateBox.appendChild(goBack)

    await manifest.layerLoading; // if the shapefiles aren't yet loaded, we need to wait for them
    manifest.countyLayer.addTo(map);

    var availableColors = {}
    Object.assign(availableColors, manifest.colors)
    console.log(availableColors)

    let totalVotes = (await queryWorker('select sum(votes) as votes from state_results_idx where officeId=?', [manifest.office.id]))[0].votes

    var candidates = await queryWorker("select candidateName as name, candidateId as id, votes from state_results_idx where officeId=? ORDER BY votes DESC", [manifest.office.id])
    for (let candidate of candidates) {
      console.log(availableColors)
      let color = availableColors[candidateColor(candidate.name, availableColors)]
      delete availableColors[candidateColor(candidate.name, availableColors)];
      candidate.color = '#' + color[4];

      var cb = document.createElement("div");
      cb.classList.add("candidate-box");
      cb.style.borderColor = candidate.color;

      var candidateName = document.createElement("div")
      candidateName.className = "candidate-name"
      candidateName.innerHTML = candidate.name
      cb.appendChild(candidateName)

      let candidateRow = candidate
      console.log(candidateRow)

      var percentageBox = document.createElement("div")
      percentageBox.className = 'candidate-percentage'
      percentageBox.style.color = '#' + color[4]
      percentageBox.innerHTML = ((candidateRow.votes / totalVotes) * 100).toFixed(2) + '%'
      cb.appendChild(percentageBox)

      var rawVotes = document.createElement('div')
      rawVotes.className = 'candidate-raw-votes'
      rawVotes.innerHTML = candidateRow.votes.toLocaleString(undefined)
      cb.appendChild(rawVotes)

      candidateBox.appendChild(cb);
    }
  }

  let db;
  async function work() {
    db = await loadDatabase();
    loadElectionManifest();
  }

  work();

    manifest.colors = {
      red: ['FFBEBE', 'FF8585', 'FF5252', 'D40000', '8C0000'],
      blue: ['B0C4FF', '739DFF', '5277FF', '2846B3', '001A66'],
      green: ['A7FFDE', '69FFB4', '52FFA8', '00A378', '005138'],
      purple: ['E2B2FF', 'B883FF', 'B852FF', '8F00FF', '5900A6'],
      yellow: ['FFFFBF', 'FFFF8C', 'FFFF52', 'E5E500', '999900']
    }
</script>

<script>
  async function createWorker() {
    manifest.worker = new Worker('worker.js')
    manifest.worker.queries = {}
    manifest.worker.onmessage = function(event) {
      if (event.data.state) {
        if (event.data.state == 'connected') {
          resolvePromise();
        }
      } else if (event.data.result) {
        queryResolved(event.data)
      }
    }

    manifest.worker.postMessage({action:'init'})

    return new Promise((resolve, reject) => {
      resolvePromise = resolve;
      rejectPromise = reject

      manifest.worker.onerror = rejectPromise
      manifest.worker.onmessageerror = rejectPromise
    })
  }

  manifest.workerCreator = createWorker();

  async function queryResolved(data) {
    manifest.worker.queries[data.id].promise.resolve(data.result)
  }

  async function queryWorker(query, params=[]) {
    await manifest.workerCreator;
    var uuid = generateUUID();
    manifest.worker.queries[uuid] = {}

    var p = new Promise((resolve, reject) => {
      resolvePromise = resolve;
      rejectPromise = reject
    });

    p.resolve = resolvePromise;

    manifest.worker.queries[uuid].promise = p

    manifest.worker.postMessage({action:'query', query:query, params:params, id:uuid})
    return p
  }

  async function materializeViews() {
    return new Promise((resolve, reject) => {
      let promises = [];

      promises.push(queryWorker('create table municipal_results_idx as select * from municipal_results'))
      promises.push(queryWorker('create table state_results_idx as select * from state_results'))

      Promise.all(promises).then(() => {
        resolve();
      }).catch(error => {
        reject(error)
      })
    })
  }

  manifest.materializeViews = materializeViews();
</script>

</body>
</html>