<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ohio Election Visualizer</title>
  <!-- Include Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Include Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Include Leaflet Shapefile JavaScript -->
  <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
  <script src="http://calvinmetcalf.github.io/leaflet.shapefile/leaflet.shpfile.js"></script>
  <style>
    body {
    margin: 0;
    display: flex;
  }

  #map {
    width: 50%;
    height: 100vh;
  }

  #info-box {
    width: 50%;
    height: 100vh;
    box-sizing: border-box;
    padding: 20px;
    background-color: #f0f0f0;
  }

  .candidate-box {
    border: 1px solid #ccc;
    margin-bottom: 10px;
    padding: 10px;
    background-color: #f9f9f9;
    /*cursor: pointer; /* Add pointer cursor for clickable effect 
    transition: background-color 0.3s; /* Smooth transition for background color change on mouseover */
  }

  .election-box {
    cursor: pointer; /* Add pointer cursor for clickable effect  */
    transition: background-color 0.3s; /* Smooth transition for background color change on mouseover */
  }

  .election-box:hover {
    background-color: #e0e0e0;
  }

  /*.candidate-box:hover {
    background-color: #e0e0e0; /* Change background color on mouseover */
  }*/

  .candidate-name {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .candidate-percentage {
    float: right;
    margin-top: -20px; /* Adjust as needed for alignment */
  }

  .candidate-raw-votes {
    font-size: 0.8em;
    margin-top: 5px;
    color: #888;
  }

  #candidates {
    overflow-y: auto; /* Make the info-box scrollable */
    height: 90%;
  }
  </style>
</head>


<body>

<!-- Create a div to hold the map -->
<div id="map"></div>
<div id="info-box">
  <h2 id="county-name">Ohio Election Visualizer</h2>
  <div id="candidates">
    <!--<div class='candidate-box'>
      <div class='candidate-name'>2023 General</div>
      <div class='candidate-raw-votes'>November 7</div>
    </div>
    <div class='candidate-box'>
      <div class='candidate-name'>2023 Special</div>
      <div class='candidate-raw-votes'>August 8</div>
    </div>
    <!-- Candidate boxes with dummy values
    <div class="candidate-box">
      <div class="candidate-name">Candidate 1</div>
      <div class="candidate-percentage">45%</div>
      <div class="candidate-raw-votes">12,000</div>
    </div>
    <div class="candidate-box">
      <div class="candidate-name">Candidate 2</div>
      <div class="candidate-percentage">30%</div>
      <div class="candidate-raw-votes">8,000</div>
    </div>
    <!-- Add more candidate boxes with dummy values as needed -->
  </div>
</div>

<script>
  // this is for our election processing

  /*for (var n in elections) {
    var election = elections[n];

    var candidateBox = document.createElement('div');
    candidateBox.classList.add('candidate-box');
    if (election.enabled == undefined || election.enabled == true) {
      candidateBox.classList.add('election-box')
    } else {
      candidateBox.style.backgroundColor = '#CCCCCC'
    }

    var ele = document.createElement('div');
    ele.className = 'candidate-name';
    ele.textContent = n + " Election";

    var date = document.createElement('div');
    date.className = 'candidate-raw-votes';
    date.textContent = election.date;

    candidateBox.appendChild(ele);
    candidateBox.appendChild(date);

    // Append the candidateBox directly to the candidates container
    document.getElementById('candidates').appendChild(candidateBox);
  }*/

</script>

<script>
  function toTitleCase(str) {
    return str.replace(/\w\S*/g, function (txt) {
      return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
    });
  }

    // Initialize the map
  var map = L.map('map').setView([39.9612, -82.9988], 7); // Set initial coordinates and zoom level

  // Add a tile layer (you can use other tile providers)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  // Load county Shapefile data using Leaflet Shapefile
  var countyLayer, subdivisionLayer;

  function loadCountyShapefile(url) {
    shp(url).then(function (geojson) {
      if (geojson) {
        countyLayer = L.geoJSON(geojson, {
          style: {color: 'black', fillColor: 'black', weight: 0.5}
        });

        countyLayer.on('mouseover', function(event){
          countyLayer.eachLayer(function (otherLayer){
            if (otherLayer !== event.layer) {
              otherLayer.setStyle({
                fillOpacity: 0
              })
            }
          }) 
          //L.popup().setLatLng(event.latlng).setContent(event.layer.feature.properties.COUNTY).openOn(map);
          document.getElementById('county-name').innerHTML = toTitleCase(event.layer.feature.properties.COUNTY) + " County";
        });

        countyLayer.on('mouseout', function(event){
          countyLayer.resetStyle(event.layer)
          //map.closePopup();
          countyLayer.eachLayer(function (layer) {
            countyLayer.resetStyle(layer);
          })
        });

        // Handle click event on county layer
        countyLayer.on('click', function (event) {
          // Get clicked county feature
          var countyFeature = event.layer.feature;

          // Zoom to the clicked county
          map.fitBounds(event.layer.getBounds());

          // Load and show subdivisions layer
          loadSubdivisionShapefile('http://localhost:3000/2023/tl_2023_39_cousub', countyFeature);

          // Remove the county layer
          map.removeLayer(countyLayer);
        });
      } else {
        console.error('Error loading county Shapefile.');
      }
    }).catch(function (error) {
      console.log(error)
      console.error('Error loading county Shapefile:', error);
    });
  }

  function loadSubdivisionShapefile(url, countyFeature) {
    console.log(countyFeature)
    shp(url).then(function (geojson) {
      if (geojson) {
        // remove those which are not part of this county
        var filteredLayer = geojson.features.filter(function (feature) {
          return ("39" + feature.properties.COUNTYFP) == countyFeature.properties.FIPS_COUNT;
        });

        subdivisionLayer = L.geoJSON(filteredLayer, {
          style: {color: 'black', fillColor: 'black', weight: 0.5}
        }).addTo(map);

        subdivisionLayer.on('click', function(event){
          console.log(event.layer.feature);
        });

        subdivisionLayer.on('mouseover', function(event){
          //L.popup().setLatLng(event.latlng).setContent(event.layer.feature.properties.NAMELSAD).openOn(map);
          document.getElementById('county-name').innerHTML = toTitleCase(event.layer.feature.properties.NAMELSAD)
          subdivisionLayer.eachLayer(function (otherLayer) {
            if (otherLayer !== event.layer) {
              otherLayer.setStyle({
                fillOpacity: 0
              })
            }
          })
        });

        subdivisionLayer.on('mouseout', function (event) {
          subdivisionLayer.eachLayer(function (layer){
            subdivisionLayer.resetStyle(layer);
          })
        });
      } else {
        console.error('Error loading subdivision Shapefile.');
      }
    }).catch(function (error) {
      console.error('Error loading subdivision Shapefile:', error);
    });
  }

  // Load the initial county Shapefile
  var counties = loadCountyShapefile('http://localhost:3000/county/REFER_COUNTY');


  // Listen for map moveend event
  map.on('zoomend', function () {
    // Get the current bounds of the map
    var bounds = map.getBounds();

    // Check if, for example, 50% of the state has come back into view
    // You can adjust this threshold as needed
    if (checkPercentageInView(bounds) > 0.5) {
      if (map.hasLayer(subdivisionLayer)) {
        map.addLayer(countyLayer);
        map.removeLayer(subdivisionLayer);
        map.panTo([39.9612, -82.9988]);
      }
    }
  });

  function checkPercentageInView(bounds) {
    // Define the bounding box of the state (adjust these coordinates based on your state)
    var stateBounds = L.latLngBounds(
      L.latLng(37.7719, -85.6052), // Southwest corner
      L.latLng(41.9773, -80.5188)  // Northeast corner
    );

    // Get the intersection of the state bounds and the current map bounds
    var intersection = getIntersection(bounds, stateBounds);

    // Calculate the percentage of the state bounds that is in view
    var percentageInView = (intersection.getNorthEast().lat - intersection.getSouthWest().lat) / (stateBounds.getNorthEast().lat - stateBounds.getSouthWest().lat);

    // You can adjust the threshold percentage as needed (e.g., 0.5 for 50%)
    return percentageInView;
  }

  // Function to calculate the intersection of two bounding boxes
  function getIntersection(bounds1, bounds2) {
    var swLat = Math.max(bounds1.getSouthWest().lat, bounds2.getSouthWest().lat);
    var swLng = Math.max(bounds1.getSouthWest().lng, bounds2.getSouthWest().lng);
    var neLat = Math.min(bounds1.getNorthEast().lat, bounds2.getNorthEast().lat);
    var neLng = Math.min(bounds1.getNorthEast().lng, bounds2.getNorthEast().lng);

    return L.latLngBounds(L.latLng(swLat, swLng), L.latLng(neLat, neLng));
  }

</script>

</body>
</html>